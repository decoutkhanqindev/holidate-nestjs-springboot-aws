{
  "name": "holidate_training_ai_agent_n8n_with_pinecone",
  "nodes": [
    {
      "parameters": {
        "mode": "insert",
        "pineconeIndex": {
          "__rl": true,
          "value": "holidate-training-ai-agent-n8n-index",
          "mode": "list",
          "cachedResultName": "holidate-training-ai-agent-n8n-index"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStorePinecone",
      "typeVersion": 1.3,
      "position": [
        640,
        -128
      ],
      "id": "263f26b7-e633-4492-8c8d-58ced5e38dc3",
      "name": "Pinecone Vector Store",
      "credentials": {
        "pineconeApi": {
          "id": "MhJjsFjO00aj8Zen",
          "name": "PineconeApi account"
        }
      }
    },
    {
      "parameters": {
        "model": "text-embedding-3-large",
        "options": {
          "dimensions": 3072
        }
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        560,
        128
      ],
      "id": "e3610bed-0579-453a-a237-89ec5f640418",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "DM5TLJVcvl7xyaex",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "url": "https://s3.ap-southeast-1.amazonaws.com/holidate-storage/?list-type=2&prefix=knowledge_base/vietnam/thanh-pho-nha-trang/thanh-pho-nha-trang/hotels/golden-hotel-nha-trang.md ",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "aws",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -528,
        -128
      ],
      "id": "02e6fd81-60ce-4f68-b315-60114cb7f364",
      "name": "Get KB data from S3",
      "credentials": {
        "aws": {
          "id": "HlsXaRvTuWFUrXHC",
          "name": "AWS (IAM) account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// N8N CODE NODE - Clean Markdown Optimized\n// Tá»‘i Æ°u pháº§n cleanedContent: loáº¡i bá» kÃ½ tá»± rÃ¡c, giá»¯ nguyÃªn ná»™i dung ngá»¯ nghÄ©a\n\nfor (const item of $input.all()) {\n  const binaryData = item.binary;\n  if (binaryData && binaryData.data) {\n    \n    // 1. Äá»ŒC FILE Gá»C\n    const rawContent = global.Buffer.from(binaryData.data.data, 'base64').toString('utf8');\n\n    // 2. TRÃCH XUáº¤T METADATA Tá»ª YAML FRONTMATTER (Tá»‘i Æ°u cho Pinecone)\n    const metadata = {};\n    metadata.source = binaryData.data.fileName || \"unknown\";\n    \n    // TrÃ­ch xuáº¥t YAML Frontmatter (giá»¯a 2 dáº¥u ---)\n    const yamlMatch = rawContent.match(/^---\\s*([\\s\\S]*?)\\s*---/);\n    const yamlContent = yamlMatch ? yamlMatch[1] : '';\n    \n    // Helper function Ä‘á»ƒ parse YAML value\n    const parseYamlValue = (pattern, defaultValue = null) => {\n      const match = yamlContent.match(pattern);\n      if (!match) return defaultValue;\n      const value = match[1].trim();\n      // Xá»­ lÃ½ boolean\n      if (value === 'true') return true;\n      if (value === 'false') return false;\n      // Xá»­ lÃ½ sá»‘\n      if (/^\\d+$/.test(value)) return parseInt(value, 10);\n      if (/^\\d+\\.\\d+$/.test(value)) return parseFloat(value);\n      // Xá»­ lÃ½ string (bá» dáº¥u ngoáº·c kÃ©p)\n      return value.replace(/^[\"']|[\"']$/g, '');\n    };\n    \n    const parseYamlArray = (fieldName) => {\n      const arrayPattern = new RegExp(`${fieldName}:\\\\s*\\\\n((?:\\\\s+-\\\\s*\"[^\"]+\"\\\\s*\\\\n?)+)`, 's');\n      const match = yamlContent.match(arrayPattern);\n      if (!match) return [];\n      const arrayContent = match[1];\n      const items = arrayContent.match(/-\\s*\"([^\"]+)\"/g) || [];\n      return items.map(item => {\n        const value = item.match(/\"([^\"]+)\"/);\n        return value ? value[1] : null;\n      }).filter(v => v);\n    };\n    \n    const parseYamlArraySimple = (fieldName) => {\n      const pattern = new RegExp(`${fieldName}:\\\\s*\\\\n((?:\\\\s+-\\\\s*\"[^\"]+\"\\\\s*\\\\n?)+)`, 's');\n      const match = yamlContent.match(pattern);\n      if (!match) return [];\n      return (match[1].match(/\"([^\"]+)\"/g) || []).map(m => m.replace(/\"/g, ''));\n    };\n    \n    // === DOCUMENT IDENTIFICATION ===\n    metadata.doc_type = parseYamlValue(/doc_type:\\s*\"([^\"]+)\"/);\n    metadata.doc_id = parseYamlValue(/doc_id:\\s*\"([^\"]+)\"/);\n    metadata.slug = parseYamlValue(/slug:\\s*\"([^\"]+)\"/);\n    metadata.last_updated = parseYamlValue(/last_updated:\\s*\"([^\"]+)\"/);\n    metadata.language = parseYamlValue(/language:\\s*\"([^\"]+)\"/, 'vi');\n    \n    // === LOCATION (cho cáº£ hotel vÃ  room) - Äáº¦Y Äá»¦ ===\n    metadata.country = parseYamlValue(/location:\\s*\\n\\s*country:\\s*\"([^\"]+)\"/) || \n                       parseYamlValue(/country:\\s*\"([^\"]+)\"/);\n    metadata.country_code = parseYamlValue(/country_code:\\s*\"([^\"]+)\"/);\n    metadata.province = parseYamlValue(/location:\\s*[\\s\\S]*?province:\\s*\"([^\"]+)\"/) || \n                       parseYamlValue(/province:\\s*\"([^\"]+)\"/);\n    metadata.province_name = parseYamlValue(/province_name:\\s*\"([^\"]+)\"/);\n    metadata.city = parseYamlValue(/location:\\s*[\\s\\S]*?city:\\s*\"([^\"]+)\"/) || \n                    parseYamlValue(/city:\\s*\"([^\"]+)\"/);\n    metadata.city_name = parseYamlValue(/city_name:\\s*\"([^\"]+)\"/);\n    metadata.district = parseYamlValue(/location:\\s*[\\s\\S]*?district:\\s*\"([^\"]+)\"/) || \n                       parseYamlValue(/district:\\s*\"([^\"]+)\"/);\n    metadata.district_name = parseYamlValue(/district_name:\\s*\"([^\"]+)\"/);\n    metadata.ward = parseYamlValue(/location:\\s*[\\s\\S]*?ward:\\s*\"([^\"]+)\"/) || \n                   parseYamlValue(/ward:\\s*\"([^\"]+)\"/);\n    metadata.ward_name = parseYamlValue(/ward_name:\\s*\"([^\"]+)\"/);\n    metadata.street = parseYamlValue(/location:\\s*[\\s\\S]*?street:\\s*\"([^\"]+)\"/) || \n                     parseYamlValue(/street:\\s*\"([^\"]+)\"/);\n    metadata.street_name = parseYamlValue(/street_name:\\s*\"([^\"]+)\"/);\n    metadata.address = parseYamlValue(/location:\\s*[\\s\\S]*?address:\\s*\"([^\"]+)\"/) || \n                      parseYamlValue(/address:\\s*\"([^\"]+)\"/);\n    metadata.full_address = parseYamlValue(/full_address:\\s*\"([^\"]+)\"/);\n    metadata.hotel_name = parseYamlValue(/location:\\s*[\\s\\S]*?hotel_name:\\s*\"([^\"]+)\"/) || \n                         parseYamlValue(/hotel_name:\\s*\"([^\"]+)\"/);\n    \n    // Coordinates\n    const latMatch = yamlContent.match(/latitude:\\s*([\\d.]+)/) || yamlContent.match(/lat:\\s*([\\d.]+)/);\n    const lngMatch = yamlContent.match(/longitude:\\s*([\\d.]+)/) || yamlContent.match(/lng:\\s*([\\d.]+)/);\n    if (latMatch && lngMatch && parseFloat(latMatch[1]) !== 0 && parseFloat(lngMatch[1]) !== 0) {\n      metadata.latitude = parseFloat(latMatch[1]);\n      metadata.longitude = parseFloat(lngMatch[1]);\n    }\n    \n    // === HOTEL-SPECIFIC METADATA - Äáº¦Y Äá»¦ ===\n    metadata.hotel_id = parseYamlValue(/hotel_id:\\s*\"([^\"]+)\"/);\n    metadata.partner_id = parseYamlValue(/partner_id:\\s*\"([^\"]+)\"/);\n    metadata.status = parseYamlValue(/status:\\s*\"([^\"]+)\"/);\n    metadata.star_rating = parseYamlValue(/star_rating:\\s*(\\d+)/);\n    metadata.reference_min_price = parseYamlValue(/reference_min_price:\\s*(\\d+)/);\n    metadata.reference_max_price = parseYamlValue(/reference_max_price:\\s*(\\d+)/);\n    metadata.reference_min_price_room = parseYamlValue(/reference_min_price_room:\\s*\"([^\"]+)\"/);\n    metadata.total_rooms = parseYamlValue(/total_rooms:\\s*(\\d+)/);\n    metadata.available_room_types = parseYamlValue(/available_room_types:\\s*(\\d+)/);\n    metadata.review_score = parseYamlValue(/review_score:\\s*([\\d.]+)/);\n    metadata.review_count = parseYamlValue(/review_count:\\s*(\\d+)/);\n    \n    // Distances\n    metadata.to_beach_meters = parseYamlValue(/to_beach_meters:\\s*(\\d+)/);\n    metadata.to_city_center_meters = parseYamlValue(/to_city_center_meters:\\s*(\\d+)/);\n    metadata.to_airport_meters = parseYamlValue(/to_airport_meters:\\s*(\\d+)/);\n    \n    // Policies - Äáº¦Y Äá»¦\n    metadata.pets_allowed = parseYamlValue(/pets_allowed:\\s*(true|false)/);\n    metadata.smoking_allowed = parseYamlValue(/smoking_allowed:\\s*(true|false)/);\n    metadata.allows_pay_at_hotel = parseYamlValue(/allows_pay_at_hotel:\\s*(true|false)/);\n    metadata.check_in_time = parseYamlValue(/check_in_time:\\s*\"([^\"]+)\"/);\n    metadata.check_out_time = parseYamlValue(/check_out_time:\\s*\"([^\"]+)\"/);\n    metadata.early_check_in_available = parseYamlValue(/early_check_in_available:\\s*(true|false)/);\n    metadata.late_check_out_available = parseYamlValue(/late_check_out_available:\\s*(true|false)/);\n    metadata.cancellation_policy = parseYamlValue(/cancellation_policy:\\s*\"([^\"]+)\"/);\n    metadata.reschedule_policy = parseYamlValue(/reschedule_policy:\\s*\"([^\"]+)\"/);\n    metadata.smoking_policy = parseYamlValue(/smoking_policy:\\s*\"([^\"]+)\"/);\n    metadata.children_policy = parseYamlValue(/children_policy:\\s*\"([^\"]+)\"/);\n    \n    // Check-in/Check-out Policy (nested)\n    metadata.check_in_earliest_time = parseYamlValue(/check_in_policy:\\s*\\n\\s*earliest_time:\\s*\"([^\"]+)\"/);\n    metadata.check_in_latest_time = parseYamlValue(/check_in_policy:\\s*[\\s\\S]*?latest_time:\\s*\"([^\"]+)\"/);\n    metadata.check_out_latest_time = parseYamlValue(/check_out_policy:\\s*[\\s\\S]*?latest_time:\\s*\"([^\"]+)\"/);\n    metadata.late_checkout_available_policy = parseYamlValue(/check_out_policy:\\s*[\\s\\S]*?late_checkout_available:\\s*(true|false)/);\n    metadata.late_checkout_fee = parseYamlValue(/late_checkout_fee:\\s*\"([^\"]+)\"/);\n    \n    // Images\n    metadata.mainImageUrl = parseYamlValue(/mainImageUrl:\\s*\"([^\"]+)\"/);\n    const galleryMatches = yamlContent.match(/galleryImageUrls:\\s*\\n((?:\\s+- \"[^\"]+\"\\s*\\n?)+)/);\n    if (galleryMatches) {\n      metadata.galleryImageUrls = galleryMatches[1].match(/\"([^\"]+)\"/g).map(m => m.replace(/\"/g, ''));\n    }\n    \n    // === ROOM-SPECIFIC METADATA - Äáº¦Y Äá»¦ ===\n    metadata.room_id = parseYamlValue(/room_id:\\s*\"([^\"]+)\"/);\n    metadata.parent_hotel_id = parseYamlValue(/parent_hotel_id:\\s*\"([^\"]+)\"/);\n    metadata.parent_hotel_slug = parseYamlValue(/parent_hotel_slug:\\s*\"([^\"]+)\"/);\n    metadata.room_name = parseYamlValue(/room_name:\\s*\"([^\"]+)\"/);\n    metadata.room_type = parseYamlValue(/room_type:\\s*\"([^\"]+)\"/);\n    metadata.room_category = parseYamlValue(/room_category:\\s*\"([^\"]+)\"/);\n    metadata.base_price = parseYamlValue(/base_price:\\s*(\\d+)/);\n    metadata.current_price = parseYamlValue(/current_price:\\s*(\\d+)/);\n    metadata.price_note = parseYamlValue(/price_note:\\s*\"([^\"]+)\"/);\n    metadata.area_sqm = parseYamlValue(/area_sqm:\\s*([\\d.]+)/);\n    metadata.max_adults = parseYamlValue(/max_adults:\\s*(\\d+)/);\n    metadata.max_children = parseYamlValue(/max_children:\\s*(\\d+)/);\n    metadata.view = parseYamlValue(/view:\\s*\"([^\"]+)\"/);\n    metadata.view_type = parseYamlValue(/view_type:\\s*\"([^\"]+)\"/);\n    metadata.has_balcony = parseYamlValue(/has_balcony:\\s*(true|false)/);\n    metadata.has_window = parseYamlValue(/has_window:\\s*(true|false)/);\n    metadata.wifi_available = parseYamlValue(/wifi_available:\\s*(true|false)/);\n    metadata.breakfast_included = parseYamlValue(/breakfast_included:\\s*(true|false)/);\n    metadata.bed_type = parseYamlValue(/bed_type:\\s*\"([^\"]+)\"/);\n    metadata.bed_type_id = parseYamlValue(/bed_type_id:\\s*\"([^\"]+)\"/);\n    metadata.floor_range = parseYamlValue(/floor_range:\\s*\"([^\"]+)\"/);\n    metadata.quantity = parseYamlValue(/quantity:\\s*(\\d+)/);\n    metadata.room_status = parseYamlValue(/status:\\s*\"([^\"]+)\"/);\n    \n    // Pricing (nested)\n    const basePriceVnd = parseYamlValue(/base_price_vnd:\\s*([\\d.]+)/);\n    if (basePriceVnd) metadata.base_price_vnd = basePriceVnd;\n    metadata.weekend_surcharge_percent = parseYamlValue(/weekend_surcharge_percent:\\s*([\\d.]+)/);\n    metadata.holiday_surcharge_percent = parseYamlValue(/holiday_surcharge_percent:\\s*([\\d.]+)/);\n    \n    // Room Policies (nested)\n    metadata.room_max_adults = parseYamlValue(/room_policies:\\s*[\\s\\S]*?max_occupancy:\\s*[\\s\\S]*?adults:\\s*(\\d+)/);\n    metadata.room_max_children = parseYamlValue(/room_policies:\\s*[\\s\\S]*?max_occupancy:\\s*[\\s\\S]*?children:\\s*(\\d+)/);\n    metadata.extra_bed_available = parseYamlValue(/extra_bed_available:\\s*(true|false)/);\n    metadata.extra_bed_price_vnd = parseYamlValue(/extra_bed_price_vnd:\\s*(\\d+)/);\n    \n    // Price Analytics (nested)\n    metadata.min_price_next_30_days = parseYamlValue(/min_price_next_30_days:\\s*(\\d+)/);\n    metadata.max_price_next_30_days = parseYamlValue(/max_price_next_30_days:\\s*(\\d+)/);\n    metadata.avg_price_next_30_days = parseYamlValue(/avg_price_next_30_days:\\s*([\\d.]+)/);\n    metadata.price_volatility = parseYamlValue(/price_volatility:\\s*\"([^\"]+)\"/);\n    metadata.weekend_price_multiplier = parseYamlValue(/weekend_price_multiplier:\\s*([\\d.]+)/);\n    \n    // === ARRAYS (Tags) - Äáº¦Y Äá»¦ ===\n    metadata.amenity_tags = parseYamlArraySimple('amenity_tags');\n    metadata.location_tags = parseYamlArraySimple('location_tags');\n    metadata.vibe_tags = parseYamlArraySimple('vibe_tags');\n    metadata.room_amenity_tags = parseYamlArraySimple('room_amenity_tags');\n    metadata.keywords = parseYamlArraySimple('keywords');\n    \n    // === NEARBY VENUES (Array of Objects) ===\n    const nearbyVenuesMatch = yamlContent.match(/nearby_venues:\\s*\\n((?:\\s+- name:[\\s\\S]*?)+)/);\n    if (nearbyVenuesMatch) {\n      const venuesContent = nearbyVenuesMatch[1];\n      const venueItems = venuesContent.match(/- name:[\\s\\S]*?(?=\\n\\s+- name:|\\n\\s*[a-z#]|$)/g) || [];\n      metadata.nearby_venues = venueItems.map(item => {\n        const name = item.match(/name:\\s*\"([^\"]+)\"/);\n        const distance = item.match(/distance:\\s*\"([^\"]+)\"/);\n        const category = item.match(/category:\\s*\"([^\"]+)\"/);\n        const description = item.match(/description:\\s*\"([^\"]+)\"/);\n        return {\n          name: name ? name[1] : null,\n          distance: distance ? distance[1] : null,\n          category: category ? category[1] : null,\n          description: description ? description[1] : null\n        };\n      }).filter(v => v.name);\n    }\n    \n    // Fallback: TrÃ­ch xuáº¥t hotel_name tá»« content body náº¿u chÆ°a cÃ³\n    if (!metadata.hotel_name && !metadata.room_name) {\n      const contentBody = rawContent.replace(/^---[\\s\\S]*?---\\s*/, '');\n      const titleMatch = contentBody.match(/^#\\s*(?:ğŸ¨|ğŸ›ï¸|.*?)\\s*(.+?)(?:\\s*-)?$/m);\n      if (titleMatch) {\n        metadata.hotel_name = titleMatch[1].trim();\n      }\n    }\n\n    // 3. Xá»¬ LÃ LÃ€M Sáº CH VÄ‚N Báº¢N (Tá»I Æ¯U)\n    let text = rawContent;\n    \n    // --- 3.1: Loáº¡i bá» khá»‘i rÃ¡c lá»›n (gá»™p regex Ä‘á»ƒ tá»‘i Æ°u) ---\n    text = text\n      .replace(/^---[\\s\\S]*?---\\s*/, '')           // XÃ³a YAML Frontmatter\n      .replace(/^# ===.*$/gm, '')                    // XÃ³a Header trang trÃ­\n      .replace(/\\{\\{TOOL:.*?\\}\\}/g, '')              // XÃ³a code Tool\n      .replace(/!\\[.*?\\]\\([^)]*\\)/g, '');           // XÃ³a áº£nh Markdown\n    \n    // --- 3.2: Decode HTML Entities (tá»‘i Æ°u: gá»™p cÃ¡c pattern tÆ°Æ¡ng tá»±) ---\n    text = text\n      .replace(/&#10;/g, '\\n')                       // Line feed\n      .replace(/&#13;/g, '\\n')                       // Carriage return -> newline\n      .replace(/&#9;/g, ' ')                         // Tab -> space\n      .replace(/&nbsp;|&#160;/g, ' ')                // Non-breaking space\n      .replace(/&amp;/g, '&')\n      .replace(/&lt;/g, '<')\n      .replace(/&gt;/g, '>')\n      .replace(/&quot;/g, '\"')\n      .replace(/&#39;|&apos;/g, \"'\")\n      .replace(/<[^>]*>/g, '');                      // XÃ³a tháº» HTML\n    \n    // Decode HTML entities dáº¡ng sá»‘ vÃ  hex (chá»‰ giá»¯ kÃ½ tá»± há»£p lá»‡)\n    text = text\n      .replace(/&#(\\d+);/g, (_, code) => {\n        const c = parseInt(code, 10);\n        return (c === 10 || c === 13 || (c >= 32 && c <= 126) || c >= 160) \n          ? (c === 13 ? '\\n' : String.fromCharCode(c)) : '';\n      })\n      .replace(/&#x([0-9A-Fa-f]+);/g, (_, hex) => {\n        const c = parseInt(hex, 16);\n        return (c === 10 || c === 13 || (c >= 32 && c <= 126) || c >= 160) \n          ? (c === 13 ? '\\n' : String.fromCharCode(c)) : '';\n      });\n    \n    // --- 3.3: XÃ³a Ä‘á»‹nh dáº¡ng Markdown (giá»¯ text) - tá»‘i Æ°u regex ---\n    text = text\n      .replace(/^#+\\s+/gm, '')                      // XÃ³a dáº¥u # Header\n      .replace(/\\*\\*([^*]+)\\*\\*/g, '$1')             // XÃ³a Bold **\n      .replace(/\\*([^*]+)\\*/g, '$1')                 // XÃ³a Italic *\n      .replace(/__([^_]+)__/g, '$1')                 // XÃ³a Bold __\n      .replace(/^>\\s*/gm, '')                        // XÃ³a Blockquote >\n      .replace(/^\\s*[-*+]\\s+/gm, '')                 // XÃ³a dáº¥u gáº¡ch Ä‘áº§u dÃ²ng list\n      .replace(/`([^`]+)`/g, '$1');                  // XÃ³a inline code\n    \n    // --- 3.4: Xá»­ lÃ½ Báº£ng (Table Flattening) - tá»‘i Æ°u ---\n    text = text\n      .replace(/^\\|?[\\s-:|]+\\|?$/gm, '')             // XÃ³a dÃ²ng káº» báº£ng\n      .replace(/\\|/g, ' ');                           // Thay dáº¥u | báº±ng space\n    \n    // --- 3.5: XÃ³a text rÃ¡c cá»¥ thá»ƒ ---\n    text = text\n      .replace(/_ThÃ´ng tin.*?cáº­p nháº­t sá»›m\\._/g, '')\n      .replace(/_Hiá»‡n táº¡i khÃ´ng cÃ³.*?_/g, '')\n      .replace(/Disclaimer quan trá»ng/g, '')\n      .replace(/\\{\\{.*?\\}\\}/g, '');                  // XÃ³a táº¥t cáº£ template variables cÃ²n sÃ³t\n    \n    // --- 3.6: Dá»n dáº¹p cuá»‘i cÃ¹ng (tá»‘i Æ°u thá»© tá»±) ---\n    text = text\n      .replace(/\\r\\n|\\r/g, '\\n')                     // Chuáº©n hÃ³a line endings (quan trá»ng!)\n      .replace(/[\\u200B-\\u200D\\u2060\\uFEFF]/g, '')   // Loáº¡i bá» zero-width characters\n      .replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F-\\x9F]/g, '') // Loáº¡i bá» control chars\n      .replace(/[\\u2028\\u2029]/g, '\\n')              // Chuáº©n hÃ³a line separators\n      .replace(/[\\u2000-\\u200A\\u202F\\u205F\\u00A0]/g, ' ') // Chuáº©n hÃ³a space\n      .replace(/[ \\t]+/g, ' ')                       // XÃ³a khoáº£ng tráº¯ng thá»«a (quan trá»ng!)\n      .replace(/\\n\\s*\\n\\s*\\n+/g, '\\n\\n')            // Tá»‘i Ä‘a 2 dÃ²ng trá»‘ng\n      .replace(/[ \\t]+$/gm, '')                      // XÃ³a trailing whitespace\n      .replace(/[\\uFFFD\\u00AD\\0]/g, '')              // Loáº¡i bá» replacement char, soft hyphen, null\n      .trim();\n    \n    // --- 3.7: SEMANTIC CLEANING - Tá»‘i Æ°u cho Vector DB ---\n    \n    // 3.7.1: Sá»­a artifacts cÃ²n sÃ³t\n    text = text\n      .replace(/:\\s*\\}\\s*$/gm, '')                   // XÃ³a dáº¥u } cÃ²n sÃ³t á»Ÿ cuá»‘i dÃ²ng\n      .replace(/âš ï¸\\s*:\\s*$/gm, 'âš ï¸ Disclaimer quan trá»ng:') // Sá»­a tiÃªu Ä‘á» bá»‹ máº¥t\n      .replace(/âš ï¸\\s*:\\s*\\n/g, 'âš ï¸ Disclaimer quan trá»ng:\\n'); // Sá»­a tiÃªu Ä‘á» bá»‹ máº¥t (trÆ°á»ng há»£p khÃ¡c)\n    \n    // 3.7.2: Loáº¡i bá» conversational fluff (ká»‹ch báº£n chatbot)\n    text = text\n      .replace(/ğŸ“\\s*LiÃªn Há»‡\\s*&\\s*Há»— Trá»£[\\s\\S]*?HÃ£y cho tÃ´i biáº¿t káº¿ hoáº¡ch cá»§a báº¡n![\\s\\S]*$/g, '') // XÃ³a toÃ n bá»™ pháº§n liÃªn há»‡\n      .replace(/Báº¡n cÃ³ cÃ¢u há»i vá» khÃ¡ch sáº¡n nÃ y\\?[\\s\\S]*?ğŸ˜Š[\\s\\S]*$/g, '') // XÃ³a pháº§n há»— trá»£\n      .replace(/TÃ´i cÃ³ thá»ƒ giÃºp báº¡n:[\\s\\S]*?ğŸ˜Š[\\s\\S]*$/g, '') // XÃ³a danh sÃ¡ch há»— trá»£\n      .replace(/HÃ£y cho tÃ´i biáº¿t[\\s\\S]*?ğŸ˜Š[\\s\\S]*$/g, '') // XÃ³a cÃ¢u káº¿t thÃºc\n      .replace(/TÃ´i sáº½ kiá»ƒm tra ngay:[\\s\\S]*$/gm, '') // XÃ³a cÃ¢u tool call\n      .replace(/ğŸ”\\s*Äá»ƒ nháº­n bÃ¡o giÃ¡ chÃ­nh xÃ¡c cho ngÃ y báº¡n muá»‘n Ä‘i, hÃ£y cho tÃ´i biáº¿t:[\\s\\S]*?TÃ´i sáº½ kiá»ƒm tra ngay\\s*$/gm, ''); // XÃ³a Ä‘oáº¡n disclaimer thá»«a\n    \n    // 3.7.3: Loáº¡i bá» sections rá»—ng (tiÃªu Ä‘á» khÃ´ng cÃ³ ná»™i dung)\n    // XÃ³a cÃ¡c section rá»—ng cá»¥ thá»ƒ (pattern cá»¥ thá»ƒ - xá»­ lÃ½ cáº£ trÆ°á»ng há»£p khÃ´ng cÃ³ dÃ²ng trá»‘ng)\n    text = text\n      .replace(/âœ¨\\s*Tiá»‡n Nghi Ná»•i Báº­t\\s*\\n(?:\\s*\\n)?(?=[ğŸ‘¨ğŸ›ï¸ğŸ’°ğŸ“‹ğŸ“â°â­ğŸ¯âŒğŸ”„ğŸ’³])/g, '') // Section rá»—ng - nháº£y ngay sang header khÃ¡c\n      .replace(/â­\\s*ÄÃ¡nh GiÃ¡ KhÃ¡ch HÃ ng\\s*\\n(?:\\s*\\n)?(?=[ğŸ“‹ğŸ“â°ğŸ¯âŒğŸ”„ğŸ’³])/g, '') // Section rá»—ng\n      .replace(/âŒ\\s*ChÃ­nh SÃ¡ch Há»§y PhÃ²ng Chi Tiáº¿t\\s*\\n(?:\\s*\\n)?(?=[ğŸ”„ğŸ’³ğŸ“‹ğŸ“â°ğŸ¯])/g, '') // Section rá»—ng\n      .replace(/ğŸ”„\\s*ChÃ­nh SÃ¡ch Äá»•i Lá»‹ch Chi Tiáº¿t\\s*\\n(?:\\s*\\n)?(?=[ğŸ’³ğŸ“‹ğŸ“â°ğŸ¯])/g, '') // Section rá»—ng\n      .replace(/ğŸ¯\\s*PhÃ¹ Há»£p Vá»›i Ai\\?\\s*$/gm, '') // Section rá»—ng á»Ÿ cuá»‘i file\n      .replace(/ğŸ¯\\s*Äá»‹a Äiá»ƒm Giáº£i TrÃ­ Gáº§n ÄÃ¢y\\s*\\n(?:\\s*\\n)?(?=[â­ğŸ“‹ğŸ“â°ğŸ¯âŒğŸ”„ğŸ’³])/g, '') // Section rá»—ng\n      .replace(/ğŸ\\s*Khuyáº¿n MÃ£i Äang CÃ³\\s*\\n(?:\\s*\\n)?(?=[â­ğŸ“‹ğŸ“â°ğŸ¯âŒğŸ”„ğŸ’³])/g, ''); // Section rá»—ng\n    \n    // XÃ³a pattern: Header + chá»‰ cÃ³ dÃ²ng trá»‘ng + Header má»›i (generic - cáº£i thiá»‡n)\n    const lines = text.split('\\n');\n    const cleanedLines = [];\n    const headerPattern = /^[ğŸ¯â­ğŸğŸ“‹ğŸ“ğŸ›ï¸ğŸ’°â°âœ¨ğŸ‘¨|ğŸ–ï¸âŒğŸ”„ğŸ’³ğŸ“]/;\n    \n    for (let i = 0; i < lines.length; i++) {\n      const line = lines[i].trim();\n      const isHeader = headerPattern.test(line);\n      \n      if (isHeader) {\n        // Kiá»ƒm tra xem cÃ³ ná»™i dung sau header khÃ´ng\n        let hasContent = false;\n        let nextHeaderIndex = -1;\n        \n        // TÃ¬m header tiáº¿p theo hoáº·c ná»™i dung thá»±c sá»±\n        for (let j = i + 1; j < lines.length && j < i + 6; j++) {\n          const nextLine = lines[j].trim();\n          \n          // Náº¿u gáº·p header má»›i\n          if (headerPattern.test(nextLine)) {\n            nextHeaderIndex = j;\n            break;\n          }\n          \n          // Náº¿u cÃ³ ná»™i dung thá»±c sá»± (khÃ´ng pháº£i dÃ²ng trá»‘ng, khÃ´ng pháº£i chá»‰ cÃ³ dáº¥u cÃ¢u)\n          if (nextLine.length > 2 && !/^[:\\-_\\s]+$/.test(nextLine)) {\n            hasContent = true;\n            break;\n          }\n        }\n        \n        // Quyáº¿t Ä‘á»‹nh: giá»¯ header náº¿u cÃ³ ná»™i dung, xÃ³a náº¿u header ngay trÆ°á»›c header khÃ¡c\n        if (hasContent) {\n          cleanedLines.push(lines[i]);\n        } else if (nextHeaderIndex === i + 1) {\n          // Header ngay trÆ°á»›c header khÃ¡c (khÃ´ng cÃ³ dÃ²ng trá»‘ng) = section rá»—ng, bá» qua\n        } else if (nextHeaderIndex > 0 && nextHeaderIndex < i + 4) {\n          // Header trÆ°á»›c header khÃ¡c sau 1-3 dÃ²ng trá»‘ng = section rá»—ng, bá» qua\n        } else if (i === lines.length - 1) {\n          // Header á»Ÿ cuá»‘i file mÃ  khÃ´ng cÃ³ ná»™i dung = xÃ³a\n        } else {\n          // TrÆ°á»ng há»£p khÃ¡c, giá»¯ láº¡i Ä‘á»ƒ an toÃ n\n          cleanedLines.push(lines[i]);\n        }\n      } else {\n        cleanedLines.push(lines[i]);\n      }\n    }\n    \n    text = cleanedLines.join('\\n');\n    \n    // 3.7.4: Dá»n dáº¹p láº¡i sau khi xÃ³a sections\n    text = text\n      .replace(/\\n{3,}/g, '\\n\\n')                     // Tá»‘i Ä‘a 2 dÃ²ng trá»‘ng\n      .replace(/^\\s+|\\s+$/gm, '')                     // XÃ³a leading/trailing whitespace má»—i dÃ²ng\n      .trim();\n\n    // 4. GHI Dá»® LIá»†U RA\n    item.json.cleanedContent = text;\n    item.json.metadata = metadata;\n    item.binary = undefined;\n  }\n}\n\nreturn $input.all();\n\n/*\n * ============================================================\n * HÆ¯á»šNG DáºªN Sá»¬ Dá»¤NG METADATA Vá»šI PINECONE VECTOR DB\n * ============================================================\n * \n * Metadata Ä‘Ã£ Ä‘Æ°á»£c trÃ­ch xuáº¥t tá»« YAML Frontmatter vÃ  sáºµn sÃ ng cho Pinecone filtering.\n * \n * Cáº¤U HÃŒNH DATA LOADER (Pinecone):\n * \n * 1. Metadata Fields cho Filtering:\n *    - doc_type: \"hotel_profile\" | \"room_detail\"\n *    - doc_id, hotel_id, room_id: UUID strings\n *    - location: country, city, district (strings)\n *    - star_rating: integer (1-5)\n *    - reference_min_price, base_price: integer (VNÄ)\n *    - amenity_tags, location_tags, vibe_tags: arrays of strings\n *    - distances: to_beach_meters, to_city_center_meters (integers)\n *    - policies: pets_allowed, smoking_allowed (booleans)\n * \n * 2. VÃ­ dá»¥ Query vá»›i Metadata Filtering:\n * \n *    // TÃ¬m khÃ¡ch sáº¡n cÃ³ bá»ƒ bÆ¡i táº¡i Nha Trang\n *    filter = {\n *      doc_type: \"hotel_profile\",\n *      city: \"thanh-pho-nha-trang\",\n *      amenity_tags: { $in: [\"swimming_pool\", \"pool\"] }\n *    }\n * \n *    // TÃ¬m phÃ²ng giÃ¡ dÆ°á»›i 1 triá»‡u táº¡i Golden Hotel\n *    filter = {\n *      doc_type: \"room_detail\",\n *      parent_hotel_id: \"4b2d0a2d-cc1f-4030-8c07-5fa09b8229cf\",\n *      base_price: { $lt: 1000000 }\n *    }\n * \n *    // TÃ¬m khÃ¡ch sáº¡n 4-5 sao gáº§n biá»ƒn (< 500m)\n *    filter = {\n *      doc_type: \"hotel_profile\",\n *      star_rating: { $gte: 4 },\n *      to_beach_meters: { $lt: 500 }\n *    }\n * \n * 3. Cáº¥u trÃºc Metadata trong Pinecone:\n *    {\n *      id: metadata.doc_id,\n *      values: [vector embeddings],\n *      metadata: {\n *        doc_type: metadata.doc_type,\n *        hotel_id: metadata.hotel_id,\n *        city: metadata.city,\n *        star_rating: metadata.star_rating,\n *        reference_min_price: metadata.reference_min_price,\n *        amenity_tags: metadata.amenity_tags,  // Array\n *        // ... cÃ¡c trÆ°á»ng khÃ¡c\n *      }\n *    }\n * \n * 4. LÆ°u Ã½:\n *    - Arrays (amenity_tags, location_tags) cáº§n Ä‘Æ°á»£c filter báº±ng $in operator\n *    - Numbers (price, distance) dÃ¹ng $lt, $lte, $gt, $gte\n *    - Booleans dÃ¹ng exact match\n *    - Strings dÃ¹ng exact match hoáº·c $in cho multiple values\n */\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        -128
      ],
      "id": "788db194-5194-4c84-a3bd-b55e30db6880",
      "name": "Convert Mark Down files to Text files"
    },
    {
      "parameters": {
        "dataPropertyName": "=data",
        "options": {}
      },
      "type": "n8n-nodes-base.xml",
      "typeVersion": 1,
      "position": [
        -288,
        -128
      ],
      "id": "26269ef4-fa70-4cd8-9c0b-201024a0f9cb",
      "name": "Convert from XML to JSON"
    },
    {
      "parameters": {
        "fieldToSplitOut": "=ListBucketResult.Contents.Key",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -64,
        -128
      ],
      "id": "cfdde9cc-e386-4d87-8722-1100592b55b3",
      "name": "Split"
    },
    {
      "parameters": {
        "bucketName": "holidate-storage",
        "fileKey": "={{ $json['ListBucketResult.Contents.Key'] }}"
      },
      "type": "n8n-nodes-base.awsS3",
      "typeVersion": 2,
      "position": [
        160,
        -128
      ],
      "id": "3a8055f0-c0e4-4836-8af2-49f831495b7e",
      "name": "Download files from S3",
      "credentials": {
        "aws": {
          "id": "HlsXaRvTuWFUrXHC",
          "name": "AWS (IAM) account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -768,
        -128
      ],
      "id": "a367225a-148f-4eac-a344-fc4b1beb470e",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "textSplittingMode": "custom",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "source",
                "value": "={{ $json.metadata.source }}"
              },
              {
                "name": "doc_id",
                "value": "={{ $json.metadata.doc_id }}"
              },
              {
                "name": "doc_type",
                "value": "={{ $json.metadata.doc_type }}"
              },
              {
                "name": "hotel_id",
                "value": "={{ $json.metadata.hotel_id }}"
              },
              {
                "name": "hotel_name",
                "value": "={{ $json.metadata.hotel_name }}"
              },
              {
                "name": "city_name",
                "value": "={{ $json.metadata.city_name }}"
              },
              {
                "name": "district_name",
                "value": "={{ $json.metadata.district_name }}"
              },
              {
                "name": "address",
                "value": "={{ $json.metadata.address }}"
              },
              {
                "name": "star_rating",
                "value": "={{ $json.metadata.star_rating }}"
              },
              {
                "name": "review_score",
                "value": "={{ $json.metadata.review_score }}"
              },
              {
                "name": "review_count",
                "value": "={{ $json.metadata.review_count }}"
              },
              {
                "name": "price",
                "value": "={{ $json.metadata.price }}"
              },
              {
                "name": "amenities",
                "value": "={{ $json.metadata.amenities }}"
              },
              {
                "name": "breakfast_included",
                "value": "={{ $json.metadata.breakfast_included }}"
              },
              {
                "name": "room_name",
                "value": "={{ $json.metadata.room_name }}"
              },
              {
                "name": "max_adults",
                "value": "={{ $json.metadata.max_adults }}"
              },
              {
                "name": "max_children",
                "value": "={{ $json.metadata.max_children }}"
              },
              {
                "name": "view_type",
                "value": "={{ $json.metadata.view_type }}"
              },
              {
                "name": "bed_type",
                "value": "={{ $json.metadata.bed_type }}"
              },
              {
                "name": "area_sqm",
                "value": "={{ $json.metadata.area_sqm }}"
              },
              {
                "name": "wifi_available",
                "value": "={{ $json.metadata.wifi_available }}"
              },
              {
                "name": "smoking_allowed",
                "value": "={{ $json.metadata.smoking_allowed }}"
              },
              {
                "name": "to_beach_meters",
                "value": "={{ $json.metadata.to_beach_meters }}"
              },
              {
                "name": "room_type",
                "value": "={{ $json.metadata.room_type }}"
              },
              {
                "name": "has_balcony",
                "value": "={{ $json.metadata.has_balcony }}"
              }
            ]
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        768,
        144
      ],
      "id": "803af8b2-b836-40aa-a2fe-3ecf6dce52eb",
      "name": "Default Data Loader"
    },
    {
      "parameters": {
        "chunkOverlap": 100,
        "options": {
          "splitCode": "markdown"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        752,
        336
      ],
      "id": "a40609b5-dff4-4763-9a99-74d5c1a72683",
      "name": "Recursive Character Text Splitter"
    }
  ],
  "pinData": {},
  "connections": {
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Pinecone Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Get KB data from S3": {
      "main": [
        [
          {
            "node": "Convert from XML to JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Mark Down files to Text files": {
      "main": [
        [
          {
            "node": "Pinecone Vector Store",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert from XML to JSON": {
      "main": [
        [
          {
            "node": "Split",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split": {
      "main": [
        [
          {
            "node": "Download files from S3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download files from S3": {
      "main": [
        [
          {
            "node": "Convert Mark Down files to Text files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        [
          {
            "node": "Get KB data from S3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Pinecone Vector Store",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "versionId": "40b7c468-a419-4935-9944-4ba8a2163176",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c57b70723f54864769ece4aeb1aa72368bc75704a74d49344e0597a9701afb0d"
  },
  "id": "DxyILRRk29PMCTiC",
  "tags": []
}